name: Test LGTM Skills Validation

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'test-skill-*/**'
      - '.github/workflows/test-validation.yml'

jobs:
  test-basic:
    name: Test 1 - Basic Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Validate test-skill-1
        id: validate
        uses: ./
        with:
          path: './test-skill-1/SKILL.md'
          min-score: 70
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-1-results
          path: lgtm-results.json

  test-multiple:
    name: Test 2 - Multiple Skills
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Validate multiple skills
        id: validate
        uses: ./
        with:
          path: './test-skill-2/SKILL.md'
          min-score: 70
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-2-results
          path: lgtm-results.json

  test-skip-duplicates:
    name: Test 3 - Skip Duplicates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Validate with skip duplicates
        id: validate
        uses: ./
        with:
          path: './test-skill-3/SKILL.md'
          min-score: 70
          skip-duplicates: true
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-3-results
          path: lgtm-results.json

  test-high-threshold:
    name: Test 4 - High Score Threshold
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Validate with 95 min score
        id: validate
        uses: ./
        with:
          path: './test-skill-4/SKILL.md'
          min-score: 95
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-4-results
          path: lgtm-results.json

  test-security-issues:
    name: Test 5 - Security Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Validate malicious skill (should pass with lower score)
        id: validate
        uses: ./
        with:
          path: './test-skill-10/SKILL.md'
          min-score: 70
          fail-on-error: false
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-5-security-results
          path: lgtm-results.json

  test-lakera-guard:
    name: Test 6 - Lakera Guard (Optional)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Validate with Lakera Guard
        id: validate
        uses: ./
        with:
          path: './test-skill-10/SKILL.md'
          min-score: 70
          lakera-api-key: ${{ secrets.LAKERA_GUARD_API_KEY }}
          fail-on-error: false
        continue-on-error: true
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-6-lakera-results
          path: lgtm-results.json
